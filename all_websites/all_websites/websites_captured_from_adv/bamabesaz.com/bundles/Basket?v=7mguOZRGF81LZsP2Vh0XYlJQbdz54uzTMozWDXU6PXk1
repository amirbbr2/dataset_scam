(function(n,t){"use strict";function u(t,u){this.element=t;this.settings=n.extend({},r,u);this._defaults=r;this._name=i;this.init()}var i="PBasket",r={basketUrl:"/Basket",addUrl:"/Basket/Add",setQuantityUrl:"/Basket/SetQuantity",removeUrl:"/Basket/Remove",widgetUrl:"/Widgets/BasketWidget"};n.extend(u.prototype,{init:function(){var i=n("[data-basket]"),f=i.first(),u=n("[data-basket-counter]"),e=u.first(),r=this;if(i.length){n("body").on("change","[data-basket-quantity]",function(){var t=n(this),f=t.attr("min"),e=t.attr("max"),l=t.data("is-decimal"),a=l?/^\d+\.?\d*/g:/^\d+/g,s=t.val().match(a),o,i,c;s==null?t.val(f):(t.val(s.join("")),o=t.val().split("."),o.length>2&&t.val(o.shift()+"."+o.join("")));t.val().endsWith(".")&&t.val(t.value.substring(0,t.value.length-1));i=t.val()?parseFloat(t.val()):f;(i<f||i>e)&&(alert("مقدار وارد شده باید عددی بین "+f+"و "+e+" باشد"),i=i<f?f:i,i=i>e?e:i,t.val(i));var h=t.closest("[data-basket-item]"),v=h.attr("data-basket-item"),y=h.attr("data-basket-unit"),p=i;n(".basket-spinner").show();c={id:v,q:p,puid:y};n.post(r.settings.setQuantityUrl,c,function(t){u.removeClass("hide").text(t);var i=n("[data-basket-details]");i.length&&persina.api.ajaxLoad(i,i.attr("data-basket-details"),n(".basket-spinner"))})});n("body").on("click","[data-basket-remove]",function(f){f.preventDefault();n(".spinner",i).show();n(".basket-spinner").show();var e=n(this),o=e.closest("[data-basket-item]"),s=o.attr("data-basket-item"),h=o.attr("data-basket-unit"),c=e.closest("[data-basket]").is("[data-basket-noquantity],[data-basket-details]")?{id:s,puid:h}:{id:s,q:1,puid:h};n.post(r.settings.removeUrl,c,function(f){if(f.BasketQuantity==0){n("[data-basket]:not([data-basket-details])").slideUp(function(){n("[data-basket] [data-basket-item]").remove()});u.addClass("hide").text("0");var e=n("[data-basket-details]");e.length&&persina.api.ajaxLoad(e,e.attr("data-basket-details"),n(".basket-spinner"))}else u.removeClass("hide").text(f.BasketQuantity),u.length&&!i.length&&t.location.assign(r.settings.basketUrl),i.each(function(){var t=n(this),f=t.is("[data-basket-details]")?t.attr("data-basket-details"):r.settings.widgetUrl,u=null;t.is("[data-basket-details]")||(u=JSON.parse(t.attr("data-basket")),u.tabView=t.is("[data-basket-tabView]"));t.load(f,u,function(){n(".spinner",i).hide()})});n(".basket-spinner").hide()})})}n("body").on("focus",".basket-add-quantity, [data-basket-quantity]",function(){n(this).select()});n("body").on("change",".basket-add-quantity",function(){var t=n(this),o=n(t.prev()),r=t.attr("min"),u=t.attr("max"),s=t.data("is-decimal"),h=s?/^\d+\.?\d*/g:/^\d+/g,e=t.val().match(h),f,i;e==null?t.val(r):(t.val(e.join("")),f=t.val().split("."),f.length>2&&t.val(f.shift()+"."+f.join("")));t.val().endsWith(".")&&t.val(t.value.substring(0,t.value.length-1));i=t.val()?parseFloat(t.val()):r;(i<r||i>u)&&(console.log("ok"),alert("مقدار وارد شده باید عددی بین "+Number(r)+" و "+Number(u)+" باشد"),i=i<r?r:i,i=i>u?u:i,t.val(i));o.attr("data-basket-add-quantity",t.val())});n("body").on("click","[data-basket-add]",function(){var c,o,s,h,l,a;i.length||u.length?(i.slideDown(),i.find(".spinner").show(),c=n(this),o=n(this).closest("[data-basket-p]").find("[data-basket-image] img"),o.length||(o=n(this)),s=o.clone(),s.css({position:"absolute",left:o.offset().left+"px",top:o.offset().top+"px"}),n("body").append(s),h=f.length?f:e.parent(),s.animate({opacity:.1,left:h.offset().left+h.width()/2-10,top:h.offset().top+h.height()/2-10,width:20,height:20},1e3,function(){s.remove();var f=c.attr("data-basket-add"),e=c.attr("data-basket-add-quantity"),o=c.attr("data-basket-add-unit");n.post(r.settings.addUrl,{id:f,q:e,puid:o},function(f){i.length&&i.each(function(){var t=n(this),i=JSON.parse(t.attr("data-basket"));i.tabView=t.is("[data-basket-tabView]");n.post(r.settings.widgetUrl,i,function(i){t.html(n("[data-basket]",i).html())})});u.length&&(u.removeClass("hide").text(f),i.length||t.location.assign(r.settings.basketUrl))})})):(l=n(this).attr("data-basket-add"),a=n(this).attr("data-basket-add-unit"),n.post(r.settings.addUrl,{id:l,q:1,puid:a},function(n){n.error?alert("Error on adding product to basket. Please try again"):t.location.assign(r.settings.basketUrl);i.find(".spinner").hide()}))});n("body").on("click","[data-basket-ajax-modal]",function(){var t=n(this),r=n(t.data("modal"));if(r.length)r.modal("show");else if(!t.is(".progressing")){t.addClass("progressing");var e=t.data("basket-ajax-modal"),i=t.find(".fa"),u=i.attr("class"),f="fa fa-spin fa-cog fa-fw fa-lg";i.removeClass(u).addClass(f);n.get(e,function(r){n("body").append(r);n(t.data("modal")).modal("show");i.removeClass(f).addClass(u);t.removeClass("progressing")})}return!1})}});n.fn[i]=function(t){return this.each(function(){n.data(this,"plugin_"+i)||n.data(this,"plugin_"+i,new u(this,t))})}})(jQuery,window,document)