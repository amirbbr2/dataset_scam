(window.webpackJsonp=window.webpackJsonp||[]).push([["backend_connector"],{E5Jq:function(t,e,n){"use strict";n.r(e);n("bSeV");var o=n("mrSG"),s=n("x+tH");var i=n("mNbo"),r=function(){},c=function(){function t(t,e){void 0===e&&(e={}),this.sessionid=null,this.connected=!1,this._timeout=null,this._base=t,this._websocketType=t.options.websocketType,this._options=Object(o.a)({timeout:6e4},e)}return t.prototype.switchWebsocketMode=function(t){this._binFrame=new Uint8Array([126,109,126]),this._websocketType=t,this._socket.binaryType="arraybuffer"},t.prototype.connect=function(){var t=this;this._socket=new WebSocket(this._prepareUrl()),this._socket.onmessage=function(e){t._onData(e.data)},this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this)},t.prototype.send=function(t){this._socket&&this._socket.send(this._websocketType===s.WSMode.Binary?this._binEncode(t):this._encode(t))},t.prototype.disconnect=function(){this._clearIdleTimeout(),this._socket&&(this._socket.onmessage=r,this._socket.onclose=r,this._socket.onerror=r,this._socket.close())},t.prototype.usesCompression=function(){return(this._socket.extensions||"").split(",").some((function(t){var e=t.split(";",1)[0].trim();return"permessage-deflate"===e||"x-webkit-deflate-frame"===e}))},t.prototype._clearIdleTimeout=function(){null!==this._timeout&&(clearTimeout(this._timeout),this._timeout=null)},t.prototype._encode=function(e){for(var n,o="",s=Array.isArray(e)?e:[e],i=s.length,r=0;r<i;r++)o+="~m~"+(n=null===s[r]||void 0===s[r]?"":t._stringify(s[r])).length+"~m~"+n;return o},t.prototype._binEncode=function(e){for(var n=Array.isArray(e)?e:[e],o=n.length,s=0;s<o;s++)n[s]=null===n[s]||void 0===n[s]?"":n[s],n[s]="string"==typeof n[s]?t._str2ab(n[s]):n[s];var i=new Uint8Array(0);for(s=0;s<o;s++){var r=this._binEncodeMessage(n[s]),c=new Uint8Array(i.length+r.length);c.set(i,0),c.set(r,i.byteLength),i=c}return i},t.prototype._binEncodeMessage=function(e){var n=t._str2ab(e.byteLength.toString()),o=3+n.length+3+e.byteLength,s=new Uint8Array(o),i=0;return s.set(this._binFrame,i),i+=this._binFrame.length,s.set(n,i),i+=n.length,s.set(this._binFrame,i),i+=this._binFrame.length,s.set(new Uint8Array(e),i),i+=e.length,s},t.prototype._decode=function(t){var e,n,o=[];do{if("~m~"!==t.substr(0,3))return o;e="",n="";for(var s=(t=t.substr(3)).length,i=0;i<s;i++){if(n=Number(t.substr(i,1)),Number(t.substr(i,1))!==n){t=t.substr(e.length+"~m~".length),e=Number(e);break}e+=n}o.push(t.substr(0,e)),t=t.substr(e)}while(""!==t);return o},t.prototype._onData=function(t){var e;this._setTimeout(),this._websocketType===s.WSMode.Binary?e=function(t){for(var e=0,n=[],o=t.length;e<o;){if(e+3>o)throw new Error("Invalid buffer length");if(126!==t[e]||109!==t[e+1]||126!==t[e+2])throw new Error("Malformed ~m~ signature");e+=3;for(var s=0;e<o;e++){var i=t[e]-48;if(i<0||i>9)break;s=10*s+i}if(s+e+3>o)throw new Error("Invalid buffer length");if(126!==t[e]||109!==t[e+1]||126!==t[e+2])throw new Error("Malformed ~m~ signature");e+=3,n.push(t.subarray(e,e+s)),e+=s}return n
}(new Uint8Array(t)):this._websocketType===s.WSMode.Text&&(e=this._decode(t));var n=e.length;if(e&&e.length)for(var o=0;o<n;o++)this._onMessage(e[o])},t.prototype._setTimeout=function(){this._clearIdleTimeout(),this._timeout=setTimeout(this._onTimeout.bind(this),this._options.timeout)},t.prototype._onTimeout=function(){this.disconnect(),this._onDisconnect({code:4e3,reason:"socket.io timeout",wasClean:!1})},t.prototype._onMessage=function(t){this.sessionid?this._checkIfHeartbeat(t)?this._onHeartbeat(this._websocketType===s.WSMode.Binary?t.subarray(3):t.slice(3)):this._checkIfJson(t)?this._base.onMessage(JSON.parse(t.slice(3))):this._base.onMessage(t):(this.sessionid=t,this._onConnect())},t.prototype._checkIfHeartbeat=function(t){return this._checkMessageType(t,"h")},t.prototype._checkIfJson=function(t){return this._checkMessageType(t,"j")},t.prototype._checkMessageType=function(t,e){if(this._websocketType===s.WSMode.Binary){var n=e.charCodeAt(0);if(126===t[0]&&t[1]===n&&126===t[2])return!0}else if(this._websocketType===s.WSMode.Text&&t.substr(0,3)==="~"+e+"~")return!0;return!1},t.prototype._onHeartbeat=function(e){var n=this._websocketType===s.WSMode.Binary?t._ab2str(e):e;this.send("~h~"+n)},t.prototype._onConnect=function(){this.connected=!0,this._base.onConnect()},t.prototype._onDisconnect=function(t){this._clear(),this._base.onDisconnect(t),this.sessionid=null},t.prototype._clear=function(){this.connected=!1},t.prototype._prepareUrl=function(){return"wss://"+this._base.host+"/socket.io/websocket"+(this.sessionid?"/"+this.sessionid:"")+"?from="+encodeURIComponent(window.location.pathname.slice(1,50))+"&date="+encodeURIComponent(window.BUILD_TIME||"")+(Object(i.isOnMobileAppPage)("any")?"&client=mobile":"")},t.prototype._onClose=function(t){this._clearIdleTimeout(),this._onDisconnect(t)},t.prototype._onError=function(t){this._clearIdleTimeout(),this._clear(),this._base.emit("error",[t]),this.sessionid=null},t._stringify=function(t){return"[object Object]"===Object.prototype.toString.call(t)?"~j~"+JSON.stringify(t):String(t)},t._str2ab=function(t){for(var e=new Uint8Array(t.length),n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e},t._ab2str=function(t){for(var e="",n=0;n<=t.length-1;n++)e+=String.fromCharCode(t[n]);return e},t}(),h=function(){function t(t,e){this.host=t,this.options=Object(o.a)({connectTimeout:5e3,tryTransportsOnConnectTimeout:!0},e),this._connecting=!1,this._events={},this.transport=this._getTransport()}return t.prototype.isConnected=function(){return!!this.transport&&this.transport.connected},t.prototype.isConnecting=function(){return this._connecting},t.prototype.connect=function(){this.isConnected()||(this._connecting&&this.disconnect(),this._connecting=!0,this.transport.connect())},t.prototype.send=function(t){this.transport&&this.transport.connected&&this.transport.send(t)},t.prototype.disconnect=function(){this.transport&&this.transport.disconnect()},t.prototype.on=function(t,e){t in this._events||(this._events[t]=[]),this._events[t].push(e)},t.prototype.offAll=function(){this._events={}},
t.prototype.onMessage=function(t){this.emit("message",[t])},t.prototype.emit=function(t,e){if(void 0===e&&(e=[]),t in this._events)for(var n=this._events[t].concat(),o=n.length,s=0;s<o;s++)n[s].apply(this,e)},t.prototype.onConnect=function(){this.clear(),this.emit("connect")},t.prototype.onDisconnect=function(t){this.emit("disconnect",[t])},t.prototype.clear=function(){this._connecting=!1},t.prototype._getTransport=function(){return new c(this)},t}(),a=Number(window.TELEMETRY_WS_ERROR_LOGS_THRESHOLD)||0;var u=function(){function t(t,e){void 0===e&&(e={}),this._queueStack=[],this._logsQueue=[],this._telemetryObjectsQueue=[],this._reconnectCount=0,this._redirectCount=0,this._errorsCount=0,this._errorsInfoSent=!1,this._reconnectTimeout=null,this._onlineCancellationToken=null,this._initialHost=e.initialHost||null,this._suggestedHost=t,this._proHost=e.proHost,this._reconnectHost=e.reconnectHost,this._doConnect(),e.pingRequired&&-1===window.location.search.indexOf("noping")&&this._startPing()}return t.prototype.connect=function(){this._tryConnect()},t.prototype.resetCounters=function(){this._reconnectCount=0,this._redirectCount=0},t.prototype.setLogger=function(t,e){this._logger=t,this._getLogHistory=e,this._flushLogs()},t.prototype.setTelemetry=function(t){this._telemetry=t,this._telemetry.reportSent.subscribe(this,this._onTelemetrySent),this._flushTelemetry()},t.prototype.onReconnect=function(t){this._onReconnect=t},t.prototype.isConnected=function(){return!!this._socket&&this._socket.isConnected()},t.prototype.isConnecting=function(){return!!this._socket&&this._socket.isConnecting()},t.prototype.on=function(t,e){return!!this._socket&&("connect"===t&&this._socket.isConnected()?e():"disconnect"===t?this._disconnectCallbacks.push(e):this._socket.on(t,e),!0)},t.prototype.getSessionId=function(){return this._socket&&this._socket.transport?this._socket.transport.sessionid:null},t.prototype.send=function(t){return this.isConnected()?(this._socket.send(t),!0):(this._queueMessage(t),!1)},t.prototype.switchWebsocketMode=function(t){return!(!this._socket||!this._socket.transport)&&(this._socket.transport.switchWebsocketMode(t),!0)},t.prototype.getConnectionDuration=function(){return Date.now()-this._connectionStart},t.prototype.getHost=function(){var t=this._tryGetProHost();return null!==t?t:this._reconnectHost&&this._reconnectCount>3?this._reconnectHost:this._suggestedHost},t.prototype.getReconnectCount=function(){return this._reconnectCount},t.prototype.getRedirectCount=function(){return this._redirectCount},t.prototype.getConnectionStart=function(){return this._connectionStart},t.prototype.disconnect=function(){this._clearReconnectTimeout(),(this.isConnected()||this.isConnecting())&&(this._propagateDisconnect(),this._disconnectCallbacks=[],this._closeSocket())},t.prototype.isMaxRedirects=function(){return this._redirectCount>=20},t.prototype.isMaxReconnects=function(){return this._reconnectCount>=20},t.prototype.getPingInfo=function(){return this._pingInfo||null},t.prototype.usesCompression=function(){
return null!==this._socket&&this._socket.transport.usesCompression()},t.prototype._tryGetProHost=function(){return window.TradingView&&window.TradingView.onChartPage&&"battle"===window.environment&&!this._redirectCount&&-1===window.location.href.indexOf("ws_host")?this._initialHost?this._initialHost:void 0!==window.user&&window.user.pro_plan?this._proHost||this._suggestedHost:null:null},t.prototype._queueMessage=function(t){0===this._queueStack.length&&this._logMessage(0,"Socket is not connected. Queued a message"),this._queueStack.push(t)},t.prototype._processMessageQueue=function(){0!==this._queueStack.length&&(this._logMessage(0,"Processing queued messages"),this._queueStack.forEach(this.send.bind(this)),this._logMessage(0,"Processed "+this._queueStack.length+" messages"),this._queueStack=[])},t.prototype._onDisconnect=function(t){null===this._reconnectTimeout&&(this._reconnectTimeout=setTimeout(this._tryReconnect.bind(this),5e3)),this._clearOnlineCancellationToken();var e="disconnect session:"+this.getSessionId();t&&(e+=", code:"+t.code+", reason:"+t.reason),this._logMessage(0,e),this._propagateDisconnect(t),this._closeSocket(),this._queueStack=[]},t.prototype._closeSocket=function(){null!==this._socket&&(this._socket.offAll(),this._socket.disconnect(),this._socket=null)},t.prototype._logMessage=function(t,e){var n={method:t,message:e};this._logger?this._flushLogMessage(n):(n.message="["+(new Date).toISOString()+"] "+n.message,this._logsQueue.push(n))},t.prototype._flushLogMessage=function(t){switch(t.method){case 2:this._logger.logDebug(t.message);break;case 3:this._logger.logError(t.message);break;case 0:this._logger.logInfo(t.message);break;case 1:this._logger.logNormal(t.message)}},t.prototype._flushLogs=function(){var t=this;this._flushLogMessage({method:1,message:"messages from queue. Start."}),this._logsQueue.forEach((function(e){t._flushLogMessage(e)})),this._flushLogMessage({method:1,message:"messages from queue. End."}),this._logsQueue=[]},t.prototype._sendTelemetry=function(t,e){var n={event:t,params:e};this._telemetry?this._flushTelemetryObject(n):this._telemetryObjectsQueue.push(n)},t.prototype._flushTelemetryObject=function(t){this._telemetry.sendChartReport(t.event,t.params,!1)},t.prototype._flushTelemetry=function(){var t=this;this._telemetryObjectsQueue.forEach((function(e){t._flushTelemetryObject(e)})),this._telemetryObjectsQueue=[]},t.prototype._doConnect=function(){this._socket&&(this._socket.isConnected()||this._socket.isConnecting())||(this._clearOnlineCancellationToken(),this._host=this.getHost(),this._socket=new h(this._host,{websocketType:s.WSMode.Text}),this._logMessage(0,"Connecting to "+this._host),this._bindEvents(),this._disconnectCallbacks=[],this._connectionStart=Date.now(),this._socket.connect())},t.prototype._propagateDisconnect=function(t){for(var e=this._disconnectCallbacks.length,n=0;n<e;n++)this._disconnectCallbacks[n](t||{})},t.prototype._bindEvents=function(){var t=this;this._socket&&(this._socket.on("connect",(function(){var e=t.getSessionId();if("string"==typeof e){
var n=JSON.parse(e);if(n.redirect)return t._redirectCount+=1,t._suggestedHost=n.redirect,t.isMaxRedirects()&&t._sendTelemetry("redirect_bailout"),void t._redirect()}t._processMessageQueue(),t._logMessage(0,"connect session:"+e)})),this._socket.on("disconnect",this._onDisconnect.bind(this)),this._socket.on("close",this._onDisconnect.bind(this)),this._socket.on("error",(function(e){t._logMessage(0,new Date+" session:"+t.getSessionId()+" websocket error:"+JSON.stringify(e)),t._sendTelemetry("websocket_error"),t._errorsCount++,!t._errorsInfoSent&&t._errorsCount>=a&&(void 0!==t._lastConnectCallStack&&(t._sendTelemetry("websocket_error_connect_stack",{text:t._lastConnectCallStack}),delete t._lastConnectCallStack),void 0!==t._getLogHistory&&t._sendTelemetry("websocket_error_log",{text:t._getLogHistory(50).join("\n")}),t._errorsInfoSent=!0)})))},t.prototype._redirect=function(){this.disconnect(),this._reconnectWhenOnline()},t.prototype._tryReconnect=function(){this._tryConnect()&&(this._reconnectCount+=1)},t.prototype._tryConnect=function(){return this._clearReconnectTimeout(),this._lastConnectCallStack=new Error("WebSocket connect stack. Is connected: "+this.isConnected()+".").stack||"",!this.isConnected()&&(this.disconnect(),this._reconnectWhenOnline(),!0)},t.prototype._clearOnlineCancellationToken=function(){this._onlineCancellationToken&&(this._onlineCancellationToken(),this._onlineCancellationToken=null)},t.prototype._clearReconnectTimeout=function(){null!==this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)},t.prototype._reconnectWhenOnline=function(){var t,e,n=this;if(navigator.onLine)return this._logMessage(0,"Network status: online - trying to connect"),this._doConnect(),void(this._onReconnect&&this._onReconnect());this._logMessage(0,"Network status: offline - wait until online"),this._onlineCancellationToken=(t=function(){n._logMessage(0,"Network status changed to online - trying to connect"),n._doConnect(),n._onReconnect&&n._onReconnect()},e=function(){window.removeEventListener("online",e),t&&t()},window.addEventListener("online",e),function(){t=null})},t.prototype._onTelemetrySent=function(t){"websocket_error"in t&&(this._errorsCount=0,this._errorsInfoSent=!1)},t.prototype._startPing=function(){var t=this;if(!this._pingIntervalId){var e=window.location.protocol+"//"+this.getHost()+"/ping",n=0,o=0;this._pingIntervalId=setInterval((function(){var s=(new Date).getTime(),i=new XMLHttpRequest;i.open("GET",e,!0),i.send(),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&function(e){t._pingInfo=t._pingInfo||{max:0,min:1/0,avg:0};var s=(new Date).getTime()-e;s>t._pingInfo.max&&(t._pingInfo.max=s),s<t._pingInfo.min&&(t._pingInfo.min=s),n+=s,o++,t._pingInfo.avg=n/o,o>=10&&t._pingIntervalId&&(clearInterval(t._pingIntervalId),delete t._pingIntervalId)}(s)}}),1e4)}},t}();window.WSBackendConnection=new u(window.WEBSOCKET_HOST,{pingRequired:window.WS_HOST_PING_REQUIRED,proHost:window.WEBSOCKET_PRO_HOST,reconnectHost:window.WEBSOCKET_HOST_FOR_RECONNECT,
initialHost:window.WEBSOCKET_INITIAL_HOST}),window.WSBackendConnectionCtor=u},bSeV:function(t,e,n){"use strict";n.r(e)},mNbo:function(t,e,n){"use strict";function o(t){var e=new URL(String(location)).searchParams;return("new"===t||"any"===t)&&"true"===e.get("mobileapp_new")||"new"!==t&&"true"===e.get("mobileapp")}function s(t){var e;o("new")&&((e=new URL(t,location.href)).searchParams.set("mobileapp_new","true"),t=e.toString());o("old")&&((e=new URL(t,location.href)).searchParams.set("mobileapp","true"),t=e.toString());return t}n.r(e),n.d(e,"isOnMobileAppPage",(function(){return o})),n.d(e,"urlWithMobileAppParams",(function(){return s}))},"x+tH":function(t,e,n){"use strict";var o;n.r(e),n.d(e,"WSMode",(function(){return o})),function(t){t[t.Text=1]="Text",t[t.Binary=2]="Binary"}(o||(o={}))}},[["E5Jq","runtime","vendors"]]]);